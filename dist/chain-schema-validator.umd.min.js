!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).chainSchemaValidator=t()}(this,function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}
/**
	 * @license
	 * MIT License
	 *
	 * Copyright (c) 2025 MAMEDUL ISLAM
	 */class t extends Error{constructor(e){super(e.map(e=>e.message).join(". ")),this.name="ValidationError",this.details=e,this.statusCode=400}}const s=(e,t)=>e&&e.isRef?t[e.key]:e,r=e=>null!=e,a=e=>{if(/[^0-9-\s]+/.test(e))return!1;let t=0,s=!1;for(var r=(e=e.replace(/\D/g,"")).length-1;r>=0;r--){var a=e.charAt(r),i=parseInt(a,10);s&&(i*=2)>9&&(i-=9),t+=i,s=!s}return t%10==0};class i{constructor(e){this._type=e,this._rules=[],this._transformers=[],this._flags={optional:!0,nullable:!1,strip:!1},this._meta={},this._hasAsync=!1,this._schemaObject=null}required(){return this._flags.optional=!1,this}optional(){return this._flags.optional=!0,this}nullable(){return this._flags.nullable=!0,this}forbidden(){return this.addRule("forbidden",e=>!r(e),"is forbidden"),this}strip(){return this._flags.strip=!0,this}default(e){return this.addTransformer(t=>null==t?e:t),this}valid(...e){return this.addRule("valid",t=>e.includes(t),`must be one of [${e.join(", ")}]`),this}invalid(...e){return this.addRule("invalid",t=>!e.includes(t),`must not be one of [${e.join(", ")}]`),this}oneOf(e){return this.valid(...e)}notOneOf(e){return this.invalid(...e)}transform(e){return this.addTransformer(e),this}custom(e,t){return this.addRule("custom",e,t||"failed custom validation"),this}customAsync(e,t){return this._hasAsync=!0,this.addRule("customAsync",e,t||"failed async validation"),this}concat(e){return this._rules.push(...e._rules),this._transformers.push(...e._transformers),this._hasAsync=this._hasAsync||e._hasAsync,this}meta(e){return this._meta={...this._meta,...e},this}message(e){return this._rules.length>0&&(this._rules[this._rules.length-1].customMessage=e),this}min(e){return this.addRule("min",(t,r)=>"number"==typeof t?t>=s(e,r):t.length>=s(e,r),`must be at least ${e.isRef?`{${e.key}}`:e}`),this}max(e){return this.addRule("max",(t,r)=>"number"==typeof t?t<=s(e,r):t.length<=s(e,r),`must be at most ${e.isRef?`{${e.key}}`:e}`),this}length(e){return this.addRule("length",(t,r)=>t.length===s(e,r),`length must be exactly ${e.isRef?`{${e.key}}`:e}`),this}pattern(e,t){return this.addRule("pattern",t=>e.test(t),t||"fails to match pattern"),this}creditCard(){return this.addRule("creditCard",a,"must be a valid credit card number"),this}ip4(){return this.addRule("ip4",e=>/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e),"must be a valid IPv4 address"),this}ip6(){return this.addRule("ip6",e=>/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/.test(e),"must be a valid IPv6 address"),this}ip(){return this.addRule("ip",e=>ipv4Regex.test(e)||ipv6Regex.test(e),"must be a valid IP address"),this}email(){return this.addRule("email",e=>"string"==typeof e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),"must be a valid email."),this}uuid(){return this.addRule("uuid",e=>/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(e),"must be a valid UUID"),this}hex(){return this.addRule("hex",e=>/^[a-fA-F0-9]+$/.test(e),"must be a hexadecimal string"),this}token(){return this.addRule("token",e=>/^[a-zA-Z0-9_]+$/.test(e),"must be a valid token"),this}isoDate(){return this.addRule("isoDate",e=>!isNaN(new Date(e).getTime()),"must be a valid ISO date"),this}trim(){return this.addTransformer(e=>"string"==typeof e?e.trim():e),this}lowercase(){return this.addTransformer(e=>"string"==typeof e?e.toLowerCase():e),this}uppercase(){return this.addTransformer(e=>"string"==typeof e?e.toUpperCase():e),this}alphanum(){return this.addRule("alphanum",e=>/^[a-zA-Z0-9]+$/.test(e),"must only contain alphanumeric characters."),this}greater(e){return this.addRule("greater",(t,r)=>t>s(e,r),`must be greater than ${e.isRef?`{${e.key}}`:e}`),this}less(e){return this.addRule("less",(t,r)=>t<s(e,r),`must be less than ${e.isRef?`{${e.key}}`:e}`),this}integer(){return this.addRule("integer",Number.isInteger,"must be an integer"),this}positive(){return this.addRule("positive",e=>e>0,"must be positive"),this}negative(){return this.addRule("negative",e=>e<0,"must be negative"),this}port(){return this.addRule("port",e=>Number.isInteger(e)&&e>=0&&e<=65535,"must be a valid port"),this}items(e){return this.addRule("items",()=>!0,"",{schema:e}),this}unique(){return this.addRule("unique",e=>new Set(e).size===e.length,"must contain unique values"),this}has(e){return this.addRule("has",()=>!0,"must contain at least one required item",{schema:e}),this}single(){return this.addTransformer(e=>Array.isArray(e)?e:[e]),this}keys(e){return this._schemaObject=e,this}assert(e,t,s){return this.objectRules.push({type:"assert",path:e,schema:t,message:s}),this}addRule(e,t,s,r){this._rules.push({type:e,validate:t,message:s,options:r})}addTransformer(e){this._transformers.push(e)}_validateSync(e,t){if(this._hasAsync)throw new Error("Schema has async rules, use .validateAsync() instead.");let s=e;for(const e of this._transformers)s=e(s);if(void 0!==this._flags.strip&&this._flags.strip)return{value:void 0};if(!r(s)){if(!this._flags.optional)throw new Error("is required");return{value:s}}if(this._flags.nullable&&null===s)return{value:null};for(const e of this._rules)if(!e.validate(s,t))throw new Error(e.customMessage||e.message);const a=this._rules.find(e=>"items"===e.type);if("array"===this._type&&a){const e=a.options.schema;if(!Array.isArray(s))throw new Error("must be an array");const t=[];for(let r=0;r<s.length;r++){const{value:a,error:i}=e.validate(s[r]);if(i)throw new Error(`[at index ${r}] ${i.details[0].message}`);void 0!==a&&t.push(a)}s=t}if(("object"===this._type||"any"===this._type)&&this._schemaObject){const{value:e,error:t}=o.object(this._schemaObject).validate(s);if(t)throw new Error(t.details.map(e=>`${e.field}: ${e.message}`).join(", "));s=e}return{value:s}}async _validateAsync(e,t){let s=e;for(const e of this._transformers)s=e(s);if(this._flags.strip)return{value:void 0};if(!r(s)){if(!this._flags.optional)throw new Error("is required");return{value:s}}if(this._flags.nullable&&null===s)return{value:null};for(const e of this._rules){if(!await Promise.resolve(e.validate(s,t)))throw new Error(e.customMessage||e.message)}const a=this._rules.find(e=>"items"===e.type);if("array"===this._type&&a){const e=a.options.schema;s=await Promise.all(s.map(async(t,s)=>{const{value:r,error:a}=await e.validateAsync(t);if(a)throw new Error(`[at index ${s}] ${a.details[0].message}`);return void 0!==e._flags.strip&&e._flags.strip?void 0:r})).then(e=>e.filter(e=>void 0!==e))}if(("object"===this._type||"any"===this._type)&&this._schemaObject){const{value:e,error:t}=await o.object(this._schemaObject).validateAsync(s);if(t)throw new Error(t.details.map(e=>`${e.field}: ${e.message}`).join(", "));s=e}return{value:s}}validate(e){try{const{value:t}=this._validateSync(e,{});return{value:t,error:null}}catch(s){return{value:e,error:new t([{message:s.message}])}}}async validateAsync(e){try{const{value:t}=await this._validateAsync(e,{});return{value:t,error:null}}catch(s){return{value:e,error:new t([{message:s.message}])}}}}class n{constructor(e,t={}){this.schemaMap=e,this.options={abortEarly:!0,stripUnknown:!1,...t},this.objectRules=[],this.hasAsync=Object.values(e).some(e=>e._hasAsync)}or(...e){return this.objectRules.push({type:"or",peers:e}),this}and(...e){return this.objectRules.push({type:"and",peers:e}),this}xor(...e){return this.objectRules.push({type:"xor",peers:e}),this}with(e,t){return this.objectRules.push({type:"with",key:e,peers:t}),this}without(e,t){return this.objectRules.push({type:"without",key:e,peers:t}),this}_checkObjectRules(e,s){for(const a of this.objectRules)try{const t=a.peers.filter(t=>r(e[t]));if("or"===a.type&&0===t.length)throw new Error(`At least one of [${a.peers.join(", ")}] is required.`);if("and"===a.type&&t.length>0&&t.length!==a.peers.length)throw new Error(`All of [${a.peers.join(", ")}] are required when one is present.`);if("xor"===a.type&&1!==t.length)throw new Error(`Exactly one of [${a.peers.join(", ")}] is required.`);if("with"===a.type&&r(e[a.key])&&t.length!==a.peers.length)throw new Error(`'${a.key}' requires all of [${a.peers.join(", ")}].`);if("without"===a.type&&r(e[a.key])&&t.length>0)throw new Error(`'${a.key}' forbids any of [${a.peers.join(", ")}].`);if("assert"===a.type){const t=(e,t)=>t.split(".").reduce((e,t)=>e&&void 0!==e[t]?e[t]:void 0,e),s=t(e,a.path),{error:r}=a.schema.validate(s);if(r){const e=`path '${a.path}' failed validation: ${r.details[0].message}`;throw new Error(a.message||e)}}}catch(e){if(s.push({message:e.message,field:a.peers.join("|"),type:a.type}),this.options.abortEarly)throw new t(s)}}_validateObjectSync(e){if(this.hasAsync)throw new Error("Schema has async rules, use .validateAsync() instead.");const s={},r=[];let a={...e||{}};if(this.options.stripUnknown){const e=new Set(Object.keys(this.schemaMap));a=Object.keys(a).filter(t=>e.has(t)).reduce((e,t)=>({...e,[t]:a[t]}),{})}const i=new Set([...Object.keys(a),...Object.keys(this.schemaMap)]);for(const e of i){const i=this.schemaMap[e],n=a[e];if(!i){s[e]=n;continue}const{value:o,error:h}=i.validate(n);if(h&&(r.push({field:e,message:h.details[0].message,type:"field"}),this.options.abortEarly))throw new t(r);void 0!==i._flags.strip&&i._flags.strip||(s[e]=o)}if(this._checkObjectRules(s,r),r.length>0)throw new t(r);return{value:s,error:null}}async _validateObjectAsync(e){const s={},r=[];let a={...e||{}};if(this.options.stripUnknown){const e=new Set(Object.keys(this.schemaMap));a=Object.keys(a).filter(t=>e.has(t)).reduce((e,t)=>({...e,[t]:a[t]}),{})}const i=new Set([...Object.keys(a),...Object.keys(this.schemaMap)]);for(const e of i){const i=this.schemaMap[e],n=a[e];if(!i){s[e]=n;continue}const{value:o,error:h}=await i.validateAsync(n);if(h&&(r.push({field:e,message:h.details[0].message,type:"field"}),this.options.abortEarly))throw new t(r);void 0!==i._flags.strip&&i._flags.strip||(s[e]=o)}if(this._checkObjectRules(s,r),r.length>0)throw new t(r);return{value:s,error:null}}validate(e){try{return this._validateObjectSync(e)}catch(t){return{value:e,error:t}}}async validateAsync(e){try{return await this._validateObjectAsync(e)}catch(t){return{value:e,error:t}}}}const o={string:()=>new i("string"),number:()=>new i("number"),boolean:()=>new i("boolean"),array:()=>new i("array"),object:(e,t)=>new n(e,t),date:()=>new i("date"),any:()=>new i("any")};return e({schema:o,ref:e=>({isRef:!0,key:e}),ValidationError:t})});
